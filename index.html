<!DOCTYPE html>
<html lang="fi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Karttapinni Profiilit</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <style>
        body { display: flex; }
        #sidebar { width: 300px; padding: 10px; background: #f0f0f0; }
        #map { flex: 1; height: 100vh; }
        #chatbox { width: 300px; padding: 10px; background: #ddd; overflow-y: auto; height: 100vh; }
        .profile { padding: 10px; background: white; margin-top: 10px; }
        .notification { position: absolute; top: 10px; right: 10px; background: red; color: white; padding: 5px; display: none; cursor: pointer; }
    </style>
</head>
<body>
    <div id="sidebar">
        <h3>Profiilisi</h3>
        <input type="text" id="username" placeholder="Käyttäjänimi"><br>
        <textarea id="description" placeholder="Kuvaus"></textarea><br>
        <input type="file" id="profilePic" accept="image/*"><br>
        <button onclick="saveProfile()">Tallenna</button>
        <h3>Etsi käyttäjiä</h3>
        <input type="text" id="searchUser" placeholder="Hae nimellä" oninput="searchUsers()">
        <div id="userList"></div>
        <h3>Muut käyttäjät</h3>
        <div id="profileList"></div>
    </div>
    <div id="map"></div>
    <div id="chatbox">
        <h3>Viestit</h3>
        <div id="chatList"></div>
        <div id="chatWindow" style="display: none;">
            <h4 id="chatUser"></h4>
            <div id="chatMessages"></div>
            <input type="text" id="chatInput" placeholder="Kirjoita viesti...">
            <button onclick="sendMessage()">Lähetä</button>
        </div>
    </div>
    <div class="notification" id="notification" onclick="openChat()">Uusi viesti!</div>

    <script>
        let map = L.map('map').setView([60.1699, 24.9384], 10);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
        let users = {};
        let messages = {};
        let currentUser = { marker: null };
        
        function updateUserLocation(position) {
            let lat = position.coords.latitude;
            let lon = position.coords.longitude;
            currentUser.lat = lat;
            currentUser.lon = lon;
            if (currentUser.marker) {
                currentUser.marker.setLatLng([lat, lon]);
            } else {
                currentUser.marker = L.marker([lat, lon], {
                    icon: L.divIcon({
                        className: 'custom-pin',
                        html: `<div style='background:#ffcc00;border-radius:50%;width:50px;height:50px;text-align:center;line-height:50px;'><img src='${currentUser.pic || ''}' width='40' style='border-radius:50%;'></div>`
                    })
                }).addTo(map);
            }
        }
        
        navigator.geolocation.watchPosition(updateUserLocation);
        
        function saveProfile() {
            let name = document.getElementById('username').value;
            let desc = document.getElementById('description').value;
            let picInput = document.getElementById('profilePic');
            if (picInput.files[0]) {
                let reader = new FileReader();
                reader.onload = function(e) {
                    currentUser.pic = e.target.result;
                    updateUserLocation({ coords: { latitude: currentUser.lat, longitude: currentUser.lon } });
                };
                reader.readAsDataURL(picInput.files[0]);
            }
            currentUser.name = name;
            currentUser.desc = desc;
            users[name] = currentUser;
            updateProfileList();
        }

        function updateProfileList() {
            let profileList = document.getElementById('profileList');
            profileList.innerHTML = '';
            Object.values(users).forEach(user => {
                let div = document.createElement('div');
                div.className = 'profile';
                div.innerHTML = `<b>${user.name}</b><br><img src="${user.pic}" width="50" style="border-radius:50%;"><br>${user.desc}`;
                profileList.appendChild(div);
            });
        }
        
        function searchUsers() {
            let query = document.getElementById('searchUser').value.toLowerCase();
            let filteredUsers = Object.values(users).filter(u => u.name.toLowerCase().includes(query));
            let userList = document.getElementById('userList');
            userList.innerHTML = '';
            filteredUsers.forEach(user => {
                let div = document.createElement('div');
                div.innerText = user.name;
                div.onclick = () => viewProfile(user.name);
                userList.appendChild(div);
            });
        }

        function viewProfile(name) {
            let user = users[name];
            if (!user) return;
            document.getElementById('chatUser').innerText = user.name;
            document.getElementById('chatWindow').style.display = 'block';
            loadChat(user.name);
        }
        
        function sendMessage() {
            let text = document.getElementById('chatInput').value;
            let recipient = document.getElementById('chatUser').innerText;
            if (!messages[recipient]) messages[recipient] = [];
            messages[recipient].push({ sender: currentUser.name, text });
            document.getElementById('notification').style.display = 'block';
            loadChat(recipient);
        }

        function loadChat(user) {
            let chatBox = document.getElementById('chatMessages');
            chatBox.innerHTML = '';
            (messages[user] || []).forEach(msg => {
                let div = document.createElement('div');
                div.innerText = `${msg.sender}: ${msg.text}`;
                chatBox.appendChild(div);
            });
        }
    </script>
</body>
</html>
